<div data-controller="notifications" class="relative">
  <button data-action="click->notifications#toggle" class="relative">
    <!-- Bell icon -->
    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
    <% if user_signed_in? %>
      <% unread_count = current_user.notifications.unread.count %>
      <% if unread_count > 0 %>
        <span class="absolute -top-1 -right-2 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full"><%= unread_count %></span>
      <% end %>
    <% end %>
  </button>

  <div data-notifications-target="panel" class="hidden absolute right-0 mt-2 w-80 bg-[#111] border border-gray-800 rounded-md shadow-lg z-50">
    <div class="p-3">
      <% if user_signed_in? %>
        <div class="flex items-center justify-between mb-2">
          <strong>Notifications</strong>
          <%= link_to 'View all', notifications_path, class: 'text-sm text-gray-400' %>
        </div>

        <% recent = current_user.notifications.recent.limit(6) %>
        <% if recent.any? %>
          <ul class="space-y-2">
            <% recent.each do |n| %>
              <li class="p-2 rounded <%= 'bg-gray-800' if n.unread? %>">
                <div class="text-sm"><strong><%= n.actor&.username || 'System' %></strong> <span class="text-gray-500">Â· <%= n.notification_type %></span></div>
                <% if n.respond_to?(:body) && n.body.present? %>
                  <div class="text-xs text-gray-300"><%= truncate(n.body, length: 80) %></div>
                <% end %>
                <div class="text-xs text-gray-500 mt-1 flex items-center justify-between">
                  <span><%= time_ago_in_words(n.created_at) %> ago</span>
                  <% if n.notifiable.is_a?(Review) && n.notifiable.movie %>
                    <%= link_to "View", movie_path(n.notifiable.movie), class: "text-xs text-gray-400 underline" %>
                  <% end %>
                  <% unless n.read? %>
                    <%= button_to "Mark read",
                      mark_read_notification_path(n),
                      method: :post,
                      remote: true,
                      form: { 'data-remote': true },
                      class: "text-xs text-gray-400" %>
                  <% end %>
                </div>
              </li>
            <% end %>
          </ul>
        <% else %>
          <div class="text-sm text-gray-400">No notifications</div>
        <% end %>
      <% else %>
        <div class="p-3 text-sm text-gray-400">Sign in to view notifications</div>
      <% end %>
    </div>
  </div>
</div>
