<div class="min-h-screen pt-24 px-6 pb-12">
  <div class="max-w-5xl mx-auto">
    <h1 class="font-cinzel text-3xl text-cinematico-gold mb-6">Your Watch History</h1>

    <!-- Date range filter (inline) -->
    <div class="mb-6">
      <%= form_with url: watch_histories_path, method: :get, local: true, class: "flex flex-row gap-3 items-end" do |f| %>
        <div class="flex flex-col">
          <%= label_tag :watched_from, "Watched from", class: "block text-sm text-cinematico-light mb-1" %>
          <%= date_field_tag :watched_from, params[:watched_from], class: "bg-cinematico-black border border-gray-700 rounded text-cinematico-light px-3 py-2" %>
        </div>

        <div class="flex flex-col">
          <%= label_tag :watched_to, "Watched to", class: "block text-sm text-cinematico-light mb-1" %>
          <%= date_field_tag :watched_to, params[:watched_to], class: "bg-cinematico-black border border-gray-700 rounded text-cinematico-light px-3 py-2" %>
        </div>

        <div class="">
            <div class="pt-6">
              <div class="flex items-center gap-2">
                <%= f.submit "Apply", class: "px-4 py-2 bg-cinematico-gold text-cinematico-black rounded font-semibold" %>
                <%= link_to "Reset", watch_histories_path, class: "px-3 py-2 bg-transparent border border-gray-700 rounded text-cinematico-light hover:bg-gray-800" %>
              </div>
            </div>
        </div>
      <% end %>
    </div>

    <% if @watch_logs.present? && @watch_logs.any? %>
      <table class="w-full text-left border-collapse">
        <thead>
          <tr class="text-sm border-b border-gray-800">
            <%# toggle name sort asc/desc %>
            <% name_sort = params[:sort] == 'name_asc' ? 'name_desc' : 'name_asc' %>
            <th class="py-3 text-cinematico-light">Poster</th>
            <th class="py-3 text-cinematico-light"><%= link_to 'Movie', watch_histories_path(request.query_parameters.merge(sort: name_sort)), class: 'hover:underline' %></th>
            <%# toggle watched sort asc/desc %>
            <% watched_sort = params[:sort] == 'watched_asc' ? 'watched_desc' : 'watched_asc' %>
            <th class="py-3 text-cinematico-light"><%= link_to 'Watched On', watch_histories_path(request.query_parameters.merge(sort: watched_sort)), class: 'hover:underline' %></th>
            <th class="py-3 text-cinematico-light">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% @watch_logs.each do |wh| %>
            <tr class="border-b border-gray-800">
              <td class="py-3">
                <% if wh.movie %>
                  <% poster_url = wh.movie.poster_url %>
                  <% is_placeholder = poster_is_placeholder?(poster_url) %>
                  <%= image_tag poster_url, 
                      alt: is_placeholder ? "No Poster Available" : wh.movie.title,
                      class: "w-16 h-24 rounded object-cover border border-gray-800 #{'poster-placeholder' if is_placeholder}" %>
                <% else %>
                  <div class="w-16 h-24 bg-gray-800 rounded flex items-center justify-center text-xs text-gray-500">N/A</div>
                <% end %>
              </td>
              <td class="py-3">
                <% if wh.movie %>
                  <%= link_to wh.movie.title, movie_path(wh.movie), class: "text-cinematico-light hover:text-cinematico-gold" %>
                <% else %>
                  <span class="text-cinematico-light">Unknown Movie (ID: <%= wh.movie_id %>)</span>
                <% end %>
              </td>
              <td class="py-3 text-cinematico-light"><%= wh.watched_on&.strftime("%b %d, %Y") %></td>
              <td class="py-3">
                <%= button_to "Remove", watch_history_path(wh), method: :delete, class: "px-3 py-1 bg-red-600 rounded text-white text-sm" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="py-12 text-center text-cinematico-grey">
        <p>No watch history yet. Mark movies as watched on their page.</p>
      </div>
    <% end %>
  </div>
</div>
